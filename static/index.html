<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/main.css">
    <title>LibreGPT</title>
  </head>
  <body>
    <div id="conversations"></div>

    <div id="chat">
      <ul id="messages"></ul>

      <form id="form" autocomplete="off">
        <div id="prompt-and-submit">
          <textarea id="prompt" rows="1" placeholder="Ask anything..." autofocus></textarea>
          <input id="submit" type="submit" value="Send">
        </div>
        <div>
          <select id="provider">
            <option value="bai">BAI (gpt-3.5)</option>
          </select>
        </div>
      </form>
    </div>

    <script>
      const form = document.getElementById("form");
      const submit = document.getElementById("submit");
      const provider = document.getElementById("provider");
      const prompt = document.getElementById("prompt");
      const messages = document.getElementById("messages");
      let lastMessageId;

      provider.addEventListener("change", () => {
        lastMessageId = undefined;
        messages.innerHTML = "";
      });

      prompt.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          submit.click();
        }
      });

      function updatePromptArea() {
        prompt.style.cssText = "height: auto; padding: 0;";
        prompt.style.cssText = "height: " + prompt.scrollHeight + "px;";
      }

      prompt.addEventListener("input", updatePromptArea);

      function appendMessage() {
        const msg = document.createElement("li");
        messages.appendChild(msg);
        return msg;
      }

      form.addEventListener("submit", async function(e) {
        e.preventDefault();

        const trimmedPromptValue = prompt.value.trim();

        if (!trimmedPromptValue) return;

        submit.setAttribute("disabled", "");
        provider.setAttribute("disabled", "");

        appendMessage().innerText = trimmedPromptValue;

        const params = new URLSearchParams({
          provider: provider.value,
          prompt: trimmedPromptValue,
        });

        if (lastMessageId)
          params.set("pmid", lastMessageId);

        prompt.value = "";
        updatePromptArea();

        const res = await fetch(`${location.origin}/api/ask?${params}`);

        if (res.status === 200)
          lastMessageId = res.headers.get("msg-id");

        const msg = appendMessage();
        const stream = res.body.pipeThrough(new TextDecoderStream());

        for await (const chunk of stream) {
          msg.innerText += chunk;
        }

        submit.removeAttribute("disabled");
        provider.removeAttribute("disabled");
      });
    </script>
  </body>
</html>
